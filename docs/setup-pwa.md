# PWA / Android ブラウザセットアップ

PWA はサーバから直接配信されるため、追加のセットアップは不要です。Apple Developer アカウントも不要です。

## 基本的な使い方

ブラウザで `http://localhost:3939/` にアクセスするだけで利用できます。

サーバセットアップで VAPID キーを設定済みであれば、PWA の設定画面でプッシュ通知をオンにできます。VAPID 未設定でも PWA 自体はポーリングで動作します（プッシュ通知のみ無効）。

## HTTPS 証明書（LAN 越し / リモート利用時）

localhost では HTTP のままでも PWA のすべての機能が動作します。LAN 内の他端末やリモートからアクセスする場合、Web Push には HTTPS が必要です。サーバは起動時に HTTPS 用の CA 証明書とサーバ証明書を自動生成し、HTTP (ポート 3939) と HTTPS (ポート 3940) の両方でリッスンします。

CA 証明書は `server/certs/` に自動生成され、サーバ再起動後も保持されます。環境変数 `HTTPS_CERT_PATH` / `HTTPS_KEY_PATH` で外部証明書を指定することも可能です。

### ホスト名の自動検出

サーバは HTTP リクエストの Host ヘッダーを監視し、未知のホスト名やIPアドレスを検出すると HTTPS 証明書の SAN（Subject Alternative Name）に自動追加して証明書をホットスワップします。Docker 内で動作している場合でも、CA 証明書のダウンロード（`/PromptRelay-CA.pem`）時に外部ホスト名が自動的に証明書に反映されます。

起動時に追加の SAN を明示的に指定したい場合は環境変数を使用します:

```env
# カンマ区切りでドメイン名・IP を指定（Docker / Tailscale 環境向け）
HTTPS_EXTRA_SANS=myserver.tail01234.ts.net,192.168.1.100
```

### 2段階の通知制御（Web ブラウザ版）

| 設定 | 意味 |
|---|---|
| 接続: ON | サーバに接続し、承認要求を受信・応答できる状態 |
| 接続: OFF | サーバから切断。スマートフォンへの通知と tmux 自動応答をスキップ |
| 通知: ON | Web Push によりブラウザ通知バーにリアルタイム表示 |
| 通知: OFF | Web Push 通知を無効化（接続状態には影響しない） |

## Android でのインストール

1. `http://<サーバアドレス>:3939/PromptRelay-CA.pem` にアクセスして CA 証明書をダウンロード
2. 設定 → セキュリティ → 証明書のインストール → CA 証明書 で CA をインストール
3. `https://<サーバアドレス>:3940/` にアクセス
4. PWA をインストールし、プッシュ通知を有効化

> **注意**: 証明書インストールのメニューパスは Android の OS バージョンやメーカーによって異なる場合があります。「証明書」で設定を検索してください。

## iOS でのインストール（iOS 16.4 以降、Apple Developer Program 不要）

> **重要**: iOS Safari では通常のブラウザタブからは Web Push を利用できません。必ず「ホーム画面に追加」で PWA としてインストールしてください。

1. Safari で `http://<サーバアドレス>:3939/PromptRelay-CA.pem` にアクセスし CA 証明書をダウンロード
2. 設定 → 一般 → VPN とデバイス管理 → ダウンロード済みプロファイルをインストール
3. 設定 → 一般 → 情報 → 証明書信頼設定 → 該当 CA の「完全な信頼を有効にする」をオン
4. Safari で `https://<サーバアドレス>:3940/` にアクセス
5. 共有ボタン → 「ホーム画面に追加」で PWA をインストール
6. ホーム画面から PWA を起動し、プッシュ通知を有効化

## Tailscale / VPN 経由の場合

Tailscale 等の VPN 経由でもそのまま利用できます。CA 証明書をダウンロードする HTTP アクセス時に Tailscale ドメイン名が自動的に HTTPS 証明書に追加されます。

1. `http://<tailscaleドメイン>:3939/PromptRelay-CA.pem` から CA 証明書をダウンロード・インストール
2. `https://<tailscaleドメイン>:3940/` で PWA にアクセス
